<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Orders – PharmaLogic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f6f9fc;
    }
    header {
      background-color: #064635;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
    }
    .logout-btn {
      background-color: #ffffff;
      color: #064635;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .container {
      max-width: 960px;
      margin: 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f0f0f0;
      font-weight: bold;
    }

    .status {
      padding: 6px 10px;
      border-radius: 4px;
      color: white;
      font-size: 0.85rem;
      text-transform: capitalize;
    }
    .status.pending { background: #fbbf24; }
    .status.approved { background: #10b981; }
    .status.rejected { background: #ef4444; }
    .status.dispensed { background: #3b82f6; }
    .status.paid { background: #166534; }

    /* Mobile responsive */
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      th { display: none; }
      td {
        position: relative;
        padding-left: 50%;
      }
      td:before {
        position: absolute;
        top: 12px;
        left: 12px;
        white-space: nowrap;
        font-weight: bold;
      }
      td:nth-of-type(1):before { content: "Order ID"; }
      td:nth-of-type(2):before { content: "Strength"; }
      td:nth-of-type(3):before { content: "Price (£)"; }
      td:nth-of-type(4):before { content: "Status"; }
      td:nth-of-type(5):before { content: "Date"; }
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <h1>My Orders</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <!-- BODY -->
  <div class="container">
    <h2>Welcome! Here is your Purchase History</h2>
    <p id="loading">Loading your orders...</p>

    <table id="ordersTable" style="display:none;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Strength</th>
          <th>Price (£)</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // SESSION CHECK
  const customerId = localStorage.getItem("customer_id");
  if (!customerId) window.location.href = "login.html";

  async function loadOrders() {
    try {
      const res = await fetch("/api/get-orders");
      const json = await res.json();

      if (!json.success) {
        document.getElementById("loading").innerText = "Error loading orders.";
        return;
      }

      const allOrders = json.orders;
      const myOrders = allOrders.filter(o => String(o.customer_id) === String(customerId));

      const tbody = document.querySelector("#ordersTable tbody");

      if (myOrders.length === 0) {
        document.getElementById("loading").innerText = "No orders found.";
        return;
      }

      // Show table
      document.getElementById("loading").style.display = "none";
      document.getElementById("ordersTable").style.display = "";

      myOrders.forEach(order => {
        const tr = document.createElement("tr");

        const strength = order.answers?.mounjaro_strength || "-";
        const status = order.status || "pending";
        const dateFmt = new Date(order.created_at).toLocaleString();

        tr.innerHTML = `
          <td>${order.id}</td>
          <td>${strength}</td>
          <td>£${order.price || 125}</td>
          <td><span class="status ${status}">${status}</span></td>
          <td>${dateFmt}</td>
        `;

        tbody.appendChild(tr);
      });

    } catch (err) {
      document.getElementById("loading").innerHTML = "Error loading orders.";
    }
  }

  loadOrders();

  function logout() {
    localStorage.removeItem("customer_id");
    localStorage.removeItem("customer_name");
    window.location.href = "login.html";
  }
</script>

</body>
</html>
