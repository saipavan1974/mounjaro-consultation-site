<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Order Details - PharmaLogic</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
  body { background: #f5f5f5; }
  .card { border-radius: 12px; }
  .label { font-weight: 600; color: #1e3a8a; }
  .section-title { font-size: 1.3rem; margin-top: 1.5rem; font-weight: 700; color: #0f172a; }
</style>
</head>

<body>
<div class="container py-4">
  <a href="admin.html" class="btn btn-secondary mb-3">‚Üê Back to Dashboard</a>
  <h2 class="mb-4">Order / Patient Details</h2>

  <div id="loading" class="text-center mt-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3">Loading order...</p>
  </div>

  <div id="content" class="card shadow p-4 d-none"></div>
</div>

<script>
  // Get order_id from URL query
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get("order_id");

  if (!orderId) {
    document.getElementById("loading").innerHTML = "<p class='text-danger'>Missing order ID.</p>";
  } else {
    fetchOrder(orderId);
  }

  async function fetchOrder(id) {
    try {
      const res = await fetch("/api/get-orders");
      const data = await res.json();

      const order = data.find(o => o.id == id);

      if (!order) {
        document.getElementById("loading").innerHTML =
          "<p class='text-danger'>Order not found.</p>";
        return;
      }

      renderOrder(order);
    } catch (err) {
      document.getElementById("loading").innerHTML =
        "<p class='text-danger'>Server error loading order.</p>";
    }
  }

  async function updateStatus(newStatus) {
    try {
      const res = await fetch("/api/update-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          order_id: orderId,
          status: newStatus
        })
      });

      const data = await res.json();

      if (data.success) {
        alert("Order status updated!");
        location.reload();
      } else {
        alert("Update failed");
      }
    } catch (err) {
      alert("Server error");
    }
  }

  function renderOrder(order) {
    document.getElementById("loading").classList.add("d-none");
    const content = document.getElementById("content");
    content.classList.remove("d-none");

    const answers = order.answers || {};

    // Helper formatting
    const show = (v) => v ? v : "<span class='text-muted'>-</span>";

    // Convert Base64 file links to clickable
    const fileLink = (data) =>
      data ? `<a href="${data}" target="_blank" class="btn btn-sm btn-primary">View File</a>`
           : "<span class='text-muted'>No file</span>";

    content.innerHTML = `
      <h4 class="section-title">Order Summary</h4>

      <div class="mb-2"><span class="label">Order ID:</span> #${order.id}</div>
      <div class="mb-2"><span class="label">Date:</span> ${new Date(order.created_at).toLocaleString()}</div>
      <div class="mb-2"><span class="label">Status:</span> 
        <span class="badge bg-info">${order.status}</span>
      </div>

      <hr>

      <h4 class="section-title">Patient Details</h4>
      <div class="mb-2"><span class="label">Full Name:</span> ${show(order.patient_name)}</div>
      <div class="mb-2"><span class="label">Email:</span> ${show(order.billing_email || order.email)}</div>
      <div class="mb-2"><span class="label">Phone:</span> ${show(order.billing_phone || order.phone)}</div>
      <div class="mb-2"><span class="label">DOB:</span> ${show(answers.dob)}</div>

      <h4 class="section-title">Medical Details</h4>
      <div class="mb-2"><span class="label">Weight:</span> ${show(answers.weight)} kg</div>
      <div class="mb-2"><span class="label">Height:</span> ${show(answers.height)} cm</div>
      <div class="mb-2"><span class="label">BMI:</span> ${show(answers.bmi)}</div>
      <div class="mb-2"><span class="label">Mounjaro Strength:</span> ${show(answers.mounjaro_strength)}</div>
      <div class="mb-2"><span class="label">On Mounjaro:</span> ${show(answers.on_mounjaro)}</div>

      <h4 class="section-title">Billing Details</h4>
      <div class="mb-2"><span class="label">Address:</span> ${show(answers.billing_address_1)}</div>
      <div class="mb-2"><span class="label">City:</span> ${show(answers.billing_city)}</div>
      <div class="mb-2"><span class="label">Postcode:</span> ${show(answers.billing_postcode)}</div>

      <h4 class="section-title">Uploaded Files</h4>
      <div class="mb-2"><span class="label">Proof of ID:</span> ${fileLink(answers.proof_of_id)}</div>
      <div class="mb-2"><span class="label">Prescription:</span> ${fileLink(answers.previous_prescription)}</div>
      <div class="mb-2"><span class="label">Video Upload:</span> ${fileLink(answers.video_upload)}</div>

      <hr />

      <h4 class="section-title">Admin Actions</h4>

      <button class="btn btn-success me-2" onclick="updateStatus('approved')">Approve</button>
      <button class="btn btn-danger me-2" onclick="updateStatus('rejected')">Reject</button>
      <button class="btn btn-primary" onclick="updateStatus('dispensed')">Mark as Dispensed</button>

      <hr />

      <h5 class="section-title">Raw Data</h5>
      <pre class="bg-light p-3 rounded">${JSON.stringify(order, null, 2)}</pre>
    `;
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
