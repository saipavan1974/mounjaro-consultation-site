<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PharmaLogic Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .status-processing { background-color: #d1e7dd; color: #0f5132; padding: 5px 10px; border-radius: 6px; }
    .status-pending { background-color: #fff3cd; color: #664d03; padding: 5px 10px; border-radius: 6px; }
    .status-approved { background-color: #cfe2ff; color: #084298; padding: 5px 10px; border-radius: 6px; }
    .status-rejected { background-color: #f8d7da; color: #842029; padding: 5px 10px; border-radius: 6px; }
    .login-container { max-width: 400px; margin: auto; padding-top: 100px; }
    .navbar-brand { font-weight: bold; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">PharmaLogic</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="#">Admin Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="loginScreen" class="login-container">
    <h3>Admin Login</h3>
    <input type="password" id="adminPassword" class="form-control mb-3" placeholder="Enter admin password" autofocus />
    <button class="btn btn-primary" onclick="authenticate()">Login</button>
  </div>

  <div id="dashboard" style="display:none;" class="container mt-4">
    <h2 class="mb-4">Orders Dashboard (Netlify Submissions)</h2>

    <div class="mb-3">
      <label for="statusFilter" class="form-label">Filter by Status</label>
      <select id="statusFilter" class="form-select" onchange="filterStatus()">
        <option value="all">All</option>
        <option value="processing">Processing</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
    </div>

    <button class="btn btn-secondary mb-3" onclick="exportCSV()">Export to CSV</button>

    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Email / Phone</th>
          <th>Product</th>
          <th>Status</th>
          <th>Address</th>
          <th>ID Upload</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="orderTableBody"></tbody>
    </table>
  </div>

  <script>
    // --- CONFIG ---
    const adminPass = "pharmalogic123";
    const netlifyToken = "nfp_Sd1XEwU9QnkyK9B3C7aQ5QzFBUC2FdM5a872";
    const netlifyFormID = "687c076ad49c5d00089e44c4"; // from your Netlify forms URL

    let allSubmissions = [];

    // Authenticate and load dashboard
    function authenticate() {
      const pw = document.getElementById("adminPassword").value;
      if (pw === adminPass) {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        loadSubmissions();
      } else {
        alert("Incorrect password!");
      }
    }

    // Load submissions for the specific form ID
    async function loadSubmissions() {
      const headers = { Authorization: `Bearer ${netlifyToken}` };
      try {
        const res = await fetch(
          `https://api.netlify.com/api/v1/forms/${netlifyFormID}/submissions`,
          { headers }
        );
        if (!res.ok) throw new Error("Failed to fetch submissions.");
        allSubmissions = await res.json();
        renderTable(allSubmissions);
      } catch (err) {
        alert(err.message);
      }
    }

    // Render the orders table
    function renderTable(data) {
      const tbody = document.getElementById("orderTableBody");
      tbody.innerHTML = "";
      data.forEach((s, i) => {
        const d = s.data;

        // Status
        const statusRaw = (d.status || "Pending").toLowerCase();
        let cls = "status-pending";
        switch (statusRaw) {
          case "processing":
            cls = "status-processing";
            break;
          case "approved":
            cls = "status-approved";
            break;
          case "rejected":
            cls = "status-rejected";
            break;
        }

        // Customer name clickable (opens detail page)
        const customerName = d["full-name"] || d.name || "-";
        const customerNameLink = `<a href="order-detail.html?id=${s.id}" target="_blank" rel="noopener noreferrer">${customerName}</a>`;

        // Product (try multiple keys)
        const product = d.product || d["product-strength"] || "-";

        // Address
        const address = d.address || "-";

        // ID Upload: show "Uploaded" if link present, else "Not Uploaded"
        const idLink = d.idupload || d["id-upload"] || "";
        const idUploadText = idLink ? `<a href="${idLink}" target="_blank" rel="noopener noreferrer">Uploaded</a>` : "Not Uploaded";

        // Email and Phone
        const emailPhone = `${d.email || ""}${d.email && d.phone ? "<br/>" : ""}${d.phone || ""}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>#${s.number || i + 1}</td>
          <td>${customerNameLink}</td>
          <td>${emailPhone}</td>
          <td>${product}</td>
          <td><span class="${cls}">${statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1)}</span></td>
          <td>${address}</td>
          <td>${idUploadText}</td>
          <td>${new Date(s.created_at).toLocaleString()}</td>
          <td>
            <button class="btn btn-sm btn-outline-success me-1" onclick="updateStatus('${s.id}', 'Approved')">Approve</button>
            <button class="btn btn-sm btn-outline-danger" onclick="updateStatus('${s.id}', 'Rejected')">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Filter orders by status
    function filterStatus() {
      const f = document.getElementById("statusFilter").value.toLowerCase();
      renderTable(f === "all"
        ? allSubmissions
        : allSubmissions.filter(s => ((s.data.status || "Pending").toLowerCase() === f))
      );
    }

    // Export as CSV
    function exportCSV() {
      let csv = "Order ID,Name,Email,Phone,Product,Status,Address,ID Upload,Date\n";
      allSubmissions.forEach((s, i) => {
        const d = s.data;
        csv += `#${s.number || i + 1},"${d["full-name"] || d.name || ""}","${d.email || ""}","${d.phone || ""}",` +
               `"${d.product || d["product-strength"] || ""}","${d.status || "Pending"}","${d.address || ""}",` +
               `"${d.idupload || d["id-upload"] || ""}","${new Date(s.created_at).toLocaleString()}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "netlify_orders.csv";
      a.click();
    }

    // Update order status via API (Approve or Reject)
    async function updateStatus(id, newStatus) {
      try {
        const res = await fetch(
          `https://api.netlify.com/api/v1/submissions/${id}`,
          {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${netlifyToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ fields: { status: newStatus } }),
          }
        );
        if (!res.ok) throw new Error("Status update failed");
        loadSubmissions(); // reload table after status update
      } catch (err) {
        alert(err.message);
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
