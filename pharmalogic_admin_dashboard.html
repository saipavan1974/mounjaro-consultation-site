<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PharmaLogic Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa; }
    .status-processing { background-color: #d1e7dd; color: #0f5132; padding: 5px 10px; border-radius: 6px; }
    .status-pending { background-color: #fff3cd; color: #664d03; padding: 5px 10px; border-radius: 6px; }
    .status-approved { background-color: #cfe2ff; color: #084298; padding: 5px 10px; border-radius: 6px; }
    .login-container { max-width: 400px; margin: auto; padding-top: 100px; }
    .navbar-brand { font-weight: bold; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">PharmaLogic</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link active" href="#">Admin Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/index.html">Home</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div id="loginScreen" class="login-container">
  <h3>Admin Login</h3>
  <input type="password" id="adminPassword" class="form-control mb-3" placeholder="Enter admin password" />
  <button class="btn btn-primary" onclick="authenticate()">Login</button>
</div>

<div id="dashboard" style="display:none;" class="container mt-4">
  <h2 class="mb-4">Orders Dashboard (Netlify Submissions)</h2>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Netlify Access Token</label>
      <input type="password" class="form-control" id="token" placeholder="Paste your Netlify token" />
    </div>
    <div class="col-md-4">
      <label class="form-label">Form Name</label>
      <input type="text" class="form-control" id="formName" placeholder="e.g., consultation-form" />
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button class="btn btn-success w-100" onclick="loadSubmissions()">Load Orders</button>
    </div>
  </div>

  <div class="mb-3">
    <label for="statusFilter" class="form-label">Filter by Status</label>
    <select id="statusFilter" class="form-select" onchange="filterStatus()">
      <option value="all">All</option>
      <option value="Processing">Processing</option>
      <option value="Pending">Pending</option>
      <option value="Approved">Approved</option>
    </select>
  </div>

  <button class="btn btn-secondary mb-3" onclick="exportCSV()">Export to CSV</button>

  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Email / Phone</th>
        <th>Product</th>
        <th>Status</th>
        <th>Address</th>
        <th>ID Upload</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="orderTableBody"></tbody>
  </table>
</div>

<script>
  const adminPass = "pharmalogic123";
  let allSubmissions = [];
  let currentToken = "";
  let currentFormID = "";

  function authenticate() {
    const input = document.getElementById("adminPassword").value;
    if (input === adminPass) {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
    } else {
      alert("Incorrect password!");
    }
  }

  async function loadSubmissions() {
    currentToken = document.getElementById('token').value.trim();
    const formName = document.getElementById('formName').value.trim();
    if (!currentToken || !formName) return alert("Please enter access token and form name.");

    const headers = { Authorization: `Bearer ${currentToken}` };
    const formsRes = await fetch(`https://api.netlify.com/api/v1/forms`, { headers });
    const forms = await formsRes.json();
    const form = forms.find(f => f.name === formName);
    if (!form) return alert("Form not found.");
    currentFormID = form.id;

    const subsRes = await fetch(`https://api.netlify.com/api/v1/forms/${form.id}/submissions`, { headers });
    allSubmissions = await subsRes.json();
    renderTable(allSubmissions);
  }

  function renderTable(data) {
    const tbody = document.getElementById("orderTableBody");
    tbody.innerHTML = "";
    data.forEach((s, i) => {
      const d = s.data;
      const status = (d.status || "Pending");
      const statusClass = status === "Processing" ? "status-processing" : 
                          status === "Approved" ? "status-approved" : "status-pending";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>#${s.number || i + 1}</td>
        <td>${d["full-name"] || d.name || "-"}</td>
        <td>${d.email || ""}<br/>${d.phone || ""}</td>
        <td>${d.product || d["product-strength"] || "-"}</td>
        <td><span class="${statusClass}">${status}</span></td>
        <td>${d.address || "-"}</td>
        <td><a href="${d.idupload || d["id-upload"] || "#"}" target="_blank">View</a></td>
        <td>${new Date(s.created_at).toLocaleString()}</td>
        <td><button class="btn btn-sm btn-outline-success" onclick="markApproved('${s.id}')">Mark Approved</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function filterStatus() {
    const filter = document.getElementById("statusFilter").value;
    if (filter === "all") renderTable(allSubmissions);
    else {
      const filtered = allSubmissions.filter(s => (s.data.status || "Pending") === filter);
      renderTable(filtered);
    }
  }

  function exportCSV() {
    let csv = "Order ID,Name,Email,Phone,Product,Status,Address,ID Upload,Date\n";
    allSubmissions.forEach((s, i) => {
      const d = s.data;
      csv += `#${s.number || i + 1},"${d["full-name"] || d.name || ""}","${d.email || ""}","${d.phone || ""}",` +
             `"${d.product || d["product-strength"] || ""}","${d.status || "Pending"}","${d.address || ""}",` +
             `"${d.idupload || d["id-upload"] || ""}","${new Date(s.created_at).toLocaleString()}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'netlify_orders.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  async function markApproved(submissionId) {
    const headers = {
      "Authorization": `Bearer ${currentToken}`,
      "Content-Type": "application/json"
    };
    const response = await fetch(`https://api.netlify.com/api/v1/submissions/${submissionId}`, {
      method: "PUT",
      headers: headers,
      body: JSON.stringify({ fields: { status: "Approved" } })
    });
    if (response.ok) {
      alert("Marked as Approved");
      loadSubmissions();
    } else {
      alert("Failed to update status");
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
